<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estuarine Circulation Dynamics Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
        }
        .water-animation {
            animation: wave 3s ease-in-out infinite;
        }
        @keyframes wave {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .parameter-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .parameter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center water-animation">
                        <span class="text-white font-bold">üåä</span>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Estuarine Circulation Evaluator</h1>
                </div>
                <div class="text-white/80 text-sm">
                    Physical Oceanography Analysis Tool by Claudio Iturra
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Main Control Panel -->
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 mb-8 border border-white/20">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Circulation Parameters</h2>
            
            <!-- Parameter Input Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- River Input Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        üèûÔ∏è River Input
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Discharge Rate (m¬≥/s)</label>
                            <input type="number" id="riverDischarge" value="150" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="150">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Salinity (psu)</label>
                            <input type="number" id="riverSalinity" value="0.5" step="0.1" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="0.5">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Temperature (¬∞C)</label>
                            <input type="number" id="riverTemp" value="18" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="18">
                        </div>
                    </div>
                </div>

                <!-- Tidal Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        üåô Tidal Dynamics
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Tidal Range (m)</label>
                            <input type="number" id="tidalRange" value="2.5" step="0.1" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="2.5">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Tidal Period (hours)</label>
                            <input type="number" id="tidalPeriod" value="12.42" step="0.01" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="12.42">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Phase (degrees)</label>
                            <input type="number" id="tidalPhase" value="0" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Wind Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        üí® Wind Forcing
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Wind Speed (m/s)</label>
                            <input type="number" id="windSpeed" value="8" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="8">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Wind Direction (degrees)</label>
                            <input type="number" id="windDirection" value="270" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="270">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Fetch Length (km)</label>
                            <input type="number" id="fetchLength" value="15" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="15">
                        </div>
                    </div>
                </div>

                <!-- Coastal Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        üèñÔ∏è Coastal Dynamics
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Coastal Current (m/s)</label>
                            <input type="number" id="coastalCurrent" value="0.3" step="0.1" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="0.3">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Upwelling Index</label>
                            <input type="number" id="upwellingIndex" value="50" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="50">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Sea Level Anomaly (cm)</label>
                            <input type="number" id="seaLevelAnomaly" value="5" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="5">
                        </div>
                    </div>
                </div>

                <!-- Density Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        ‚öñÔ∏è Density Structure
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Surface Salinity (psu)</label>
                            <input type="number" id="surfaceSalinity" value="32" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="32">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Bottom Salinity (psu)</label>
                            <input type="number" id="bottomSalinity" value="35" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="35">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Stratification Index</label>
                            <input type="number" id="stratification" value="0.8" step="0.1" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="0.8">
                        </div>
                    </div>
                </div>

                <!-- Bathymetry Parameters -->
                <div class="parameter-card bg-white/20 rounded-xl p-6 border border-white/30">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        üó∫Ô∏è Bathymetry
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Average Depth (m)</label>
                            <input type="number" id="avgDepth" value="12" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="12">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Channel Width (km)</label>
                            <input type="number" id="channelWidth" value="3.5" step="0.1" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="3.5">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm mb-2">Roughness Coefficient</label>
                            <input type="number" id="roughness" value="0.025" step="0.001" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60" placeholder="0.025">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <div class="text-center mb-8">
                <button onclick="calculateCirculation()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üîÑ Calculate Circulation Dynamics
                </button>
            </div>
        </div>

        <!-- Equations Section -->
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 mb-8 border border-white/20">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Physical Oceanography Equations</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column - Equations -->
                <div class="space-y-6">
                    <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">üåä Residual Flow Calculation</h3>
                        <div class="text-white/90 text-sm space-y-2">
                            <p><strong>U<sub>res</sub> = U<sub>river</sub> + U<sub>wind</sub> + U<sub>coastal</sub></strong></p>
                            <p>U<sub>river</sub> = Q<sub>r</sub> / (W √ó H)</p>
                            <p>U<sub>wind</sub> = œÑ<sub>w</sub> √ó C<sub>d</sub> / (œÅ √ó H)</p>
                            <p>œÑ<sub>w</sub> = œÅ<sub>air</sub> √ó C<sub>d</sub> √ó U<sub>10</sub>¬≤</p>
                            <p class="text-xs text-white/70">Where: Q<sub>r</sub>=river discharge, W=width, H=depth, œÑ<sub>w</sub>=wind stress</p>
                        </div>
                    </div>

                    <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">‚ö° Mixing Rate</h3>
                        <div class="text-white/90 text-sm space-y-2">
                            <p><strong>M = (E<sub>tidal</sub> + E<sub>wind</sub>) / (1 + N¬≤)</strong></p>
                            <p>E<sub>tidal</sub> = U<sub>tidal</sub>¬≥</p>
                            <p>E<sub>wind</sub> = U<sub>10</sub>¬≥ / F</p>
                            <p>N¬≤ = (g/œÅ) √ó (‚àÇœÅ/‚àÇz)</p>
                            <p class="text-xs text-white/70">Where: N¬≤=buoyancy frequency, F=fetch length, g=gravity</p>
                        </div>
                    </div>

                    <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">üîÑ Circulation Index</h3>
                        <div class="text-white/90 text-sm space-y-2">
                            <p><strong>CI = (U<sub>res</sub> √ó M) / (1 + ‚àÇœÅ/‚àÇz)</strong></p>
                            <p>‚àÇœÅ/‚àÇz ‚âà Œ≤ √ó (S<sub>bottom</sub> - S<sub>surface</sub>) / H</p>
                            <p>Œ≤ = 0.78 kg/m¬≥/psu (haline contraction)</p>
                            <p class="text-xs text-white/70">Where: Œ≤=haline contraction coefficient, S=salinity</p>
                        </div>
                    </div>

                    <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">‚è±Ô∏è Flushing Time</h3>
                        <div class="text-white/90 text-sm space-y-2">
                            <p><strong>T<sub>f</sub> = V<sub>estuary</sub> / Q<sub>exchange</sub></strong></p>
                            <p>V<sub>estuary</sub> = W √ó H √ó L</p>
                            <p>Q<sub>exchange</sub> = Q<sub>river</sub> + Q<sub>tidal</sub></p>
                            <p>Q<sub>tidal</sub> = U<sub>tidal</sub> √ó W √ó H</p>
                            <p class="text-xs text-white/70">Where: L=estuary length, Q=volumetric flow rate</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Estuarine Diagram -->
                <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                    <h3 class="text-lg font-semibold text-white mb-4 text-center">Estuarine System Diagram</h3>
                    <svg viewBox="0 0 400 300" class="w-full h-auto">
                        <!-- Background -->
                        <defs>
                            <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.8" />
                                <stop offset="50%" style="stop-color:#1e40af;stop-opacity:0.9" />
                                <stop offset="100%" style="stop-color:#1e3a8a;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="landGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#16a34a;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Land masses -->
                        <path d="M0,50 Q50,30 100,50 L100,0 L0,0 Z" fill="url(#landGradient)" />
                        <path d="M300,50 Q350,30 400,50 L400,0 L300,0 Z" fill="url(#landGradient)" />
                        <path d="M0,250 Q50,270 100,250 L100,300 L0,300 Z" fill="url(#landGradient)" />
                        <path d="M300,250 Q350,270 400,250 L400,300 L300,300 Z" fill="url(#landGradient)" />
                        
                        <!-- Water body -->
                        <path d="M100,50 Q200,40 300,50 L300,250 Q200,260 100,250 Z" fill="url(#waterGradient)" />
                        
                        <!-- River input -->
                        <path d="M50,150 Q75,140 100,150 Q75,160 50,150" fill="#60a5fa" />
                        <text x="25" y="155" fill="white" font-size="10" text-anchor="middle">River</text>
                        <text x="25" y="167" fill="white" font-size="8" text-anchor="middle">Q<tspan baseline-shift="sub">r</tspan></text>
                        
                        <!-- Ocean connection -->
                        <path d="M300,150 Q325,140 350,150 Q325,160 300,150" fill="#1e40af" />
                        <text x="375" y="155" fill="white" font-size="10" text-anchor="middle">Ocean</text>
                        
                        <!-- Tidal arrows -->
                        <g stroke="white" stroke-width="2" fill="white">
                            <path d="M320,120 L340,120 M335,115 L340,120 L335,125" />
                            <path d="M340,180 L320,180 M325,175 L320,180 L325,185" />
                        </g>
                        <text x="330" y="110" fill="white" font-size="8" text-anchor="middle">Flood</text>
                        <text x="330" y="195" fill="white" font-size="8" text-anchor="middle">Ebb</text>
                        
                        <!-- Wind arrows -->
                        <g stroke="white" stroke-width="1.5" fill="white">
                            <path d="M150,30 L170,30 M165,25 L170,30 L165,35" />
                            <path d="M180,30 L200,30 M195,25 L200,30 L195,35" />
                            <path d="M210,30 L230,30 M225,25 L230,30 L225,35" />
                        </g>
                        <text x="190" y="20" fill="white" font-size="10" text-anchor="middle">Wind Stress</text>
                        
                        <!-- Salinity gradient -->
                        <g>
                            <circle cx="120" cy="150" r="3" fill="#87ceeb" />
                            <circle cx="160" cy="150" r="3" fill="#4682b4" />
                            <circle cx="200" cy="150" r="3" fill="#1e40af" />
                            <circle cx="240" cy="150" r="3" fill="#1e3a8a" />
                            <circle cx="280" cy="150" r="3" fill="#0f172a" />
                        </g>
                        <text x="200" y="280" fill="white" font-size="10" text-anchor="middle">Salinity Gradient</text>
                        <text x="120" y="290" fill="white" font-size="8" text-anchor="middle">Fresh</text>
                        <text x="280" y="290" fill="white" font-size="8" text-anchor="middle">Saline</text>
                        
                        <!-- Circulation arrows -->
                        <g stroke="#fbbf24" stroke-width="2" fill="#fbbf24">
                            <!-- Surface flow -->
                            <path d="M110,100 Q200,90 290,100" stroke-dasharray="3,3" />
                            <path d="M285,95 L290,100 L285,105" />
                            <!-- Bottom flow -->
                            <path d="M290,200 Q200,210 110,200" stroke-dasharray="3,3" />
                            <path d="M115,195 L110,200 L115,205" />
                        </g>
                        <text x="200" y="85" fill="#fbbf24" font-size="8" text-anchor="middle">Surface Flow</text>
                        <text x="200" y="225" fill="#fbbf24" font-size="8" text-anchor="middle">Bottom Flow</text>
                        
                        <!-- Mixing indicators -->
                        <g stroke="white" stroke-width="1" opacity="0.7">
                            <circle cx="150" cy="120" r="8" fill="none" stroke-dasharray="2,2" />
                            <circle cx="200" cy="130" r="10" fill="none" stroke-dasharray="2,2" />
                            <circle cx="250" cy="170" r="9" fill="none" stroke-dasharray="2,2" />
                        </g>
                        <text x="200" y="250" fill="white" font-size="8" text-anchor="middle">Turbulent Mixing</text>
                        
                        <!-- Depth indicators -->
                        <g stroke="white" stroke-width="1" stroke-dasharray="1,1">
                            <line x1="380" y1="50" x2="380" y2="250" />
                            <line x1="375" y1="50" x2="385" y2="50" />
                            <line x1="375" y1="250" x2="385" y2="250" />
                        </g>
                        <text x="395" y="155" fill="white" font-size="8" text-anchor="middle" transform="rotate(90 395 155)">Depth (H)</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 text-center">
                    <div class="text-3xl mb-2">üåä</div>
                    <div class="text-2xl font-bold text-white" id="residualFlow">--</div>
                    <div class="text-white/80 text-sm">Residual Flow (m/s)</div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 text-center">
                    <div class="text-3xl mb-2">‚ö°</div>
                    <div class="text-2xl font-bold text-white" id="mixingRate">--</div>
                    <div class="text-white/80 text-sm">Mixing Rate</div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 text-center">
                    <div class="text-3xl mb-2">üîÑ</div>
                    <div class="text-2xl font-bold text-white" id="circulationIndex">--</div>
                    <div class="text-white/80 text-sm">Circulation Index</div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 text-center">
                    <div class="text-3xl mb-2">‚è±Ô∏è</div>
                    <div class="text-2xl font-bold text-white" id="flushingTime">--</div>
                    <div class="text-white/80 text-sm">Flushing Time (days)</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h3 class="text-xl font-semibold text-white mb-4">Velocity Profile</h3>
                    <canvas id="velocityChart" width="400" height="300"></canvas>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h3 class="text-xl font-semibold text-white mb-4">Salinity Distribution</h3>
                    <canvas id="salinityChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 border border-white/20">
                <h3 class="text-2xl font-semibold text-white mb-6">Circulation Analysis</h3>
                <div id="analysisText" class="text-white/90 leading-relaxed space-y-4">
                    <!-- Analysis will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let velocityChart, salinityChart;

        function calculateCirculation() {
            // Get all input values
            const params = {
                riverDischarge: parseFloat(document.getElementById('riverDischarge').value) || 150,
                riverSalinity: parseFloat(document.getElementById('riverSalinity').value) || 0.5,
                riverTemp: parseFloat(document.getElementById('riverTemp').value) || 18,
                tidalRange: parseFloat(document.getElementById('tidalRange').value) || 2.5,
                tidalPeriod: parseFloat(document.getElementById('tidalPeriod').value) || 12.42,
                tidalPhase: parseFloat(document.getElementById('tidalPhase').value) || 0,
                windSpeed: parseFloat(document.getElementById('windSpeed').value) || 8,
                windDirection: parseFloat(document.getElementById('windDirection').value) || 270,
                fetchLength: parseFloat(document.getElementById('fetchLength').value) || 15,
                coastalCurrent: parseFloat(document.getElementById('coastalCurrent').value) || 0.3,
                upwellingIndex: parseFloat(document.getElementById('upwellingIndex').value) || 50,
                seaLevelAnomaly: parseFloat(document.getElementById('seaLevelAnomaly').value) || 5,
                surfaceSalinity: parseFloat(document.getElementById('surfaceSalinity').value) || 32,
                bottomSalinity: parseFloat(document.getElementById('bottomSalinity').value) || 35,
                stratification: parseFloat(document.getElementById('stratification').value) || 0.8,
                avgDepth: parseFloat(document.getElementById('avgDepth').value) || 12,
                channelWidth: parseFloat(document.getElementById('channelWidth').value) || 3.5,
                roughness: parseFloat(document.getElementById('roughness').value) || 0.025
            };

            // Calculate derived parameters
            const results = calculateDynamics(params);
            
            // Update UI
            updateResults(results, params);
            
            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function calculateDynamics(params) {
            // Simplified oceanographic calculations
            
            // Residual flow calculation (considering river discharge, tidal pumping, and wind)
            const tidalVelocity = (params.tidalRange * Math.PI) / (params.tidalPeriod * 3600);
            const windStress = 0.001 * params.windSpeed * params.windSpeed;
            const residualFlow = (params.riverDischarge / (params.channelWidth * 1000 * params.avgDepth)) + 
                               (windStress * 0.1) + (params.coastalCurrent * 0.2);

            // Mixing rate (based on tidal energy, wind, and stratification)
            const tidalEnergy = Math.pow(tidalVelocity, 3);
            const windMixing = Math.pow(params.windSpeed, 3) / (params.fetchLength * 1000);
            const mixingRate = (tidalEnergy + windMixing) / (1 + params.stratification);

            // Circulation index (composite measure)
            const densityGradient = (params.bottomSalinity - params.surfaceSalinity) / params.avgDepth;
            const circulationIndex = (residualFlow * mixingRate) / (1 + densityGradient);

            // Flushing time (estuary volume / exchange rate)
            const estuaryVolume = params.channelWidth * 1000 * params.avgDepth * 10000; // Assuming 10km length
            const exchangeRate = params.riverDischarge + (tidalVelocity * params.channelWidth * 1000 * params.avgDepth);
            const flushingTime = estuaryVolume / (exchangeRate * 86400); // Convert to days

            return {
                residualFlow: residualFlow.toFixed(3),
                mixingRate: mixingRate.toFixed(2),
                circulationIndex: circulationIndex.toFixed(2),
                flushingTime: flushingTime.toFixed(1),
                tidalVelocity: tidalVelocity,
                densityGradient: densityGradient
            };
        }

        function updateResults(results, params) {
            // Update key metrics
            document.getElementById('residualFlow').textContent = results.residualFlow;
            document.getElementById('mixingRate').textContent = results.mixingRate;
            document.getElementById('circulationIndex').textContent = results.circulationIndex;
            document.getElementById('flushingTime').textContent = results.flushingTime;

            // Create charts
            createVelocityChart(results, params);
            createSalinityChart(params);
            
            // Generate analysis
            generateAnalysis(results, params);
        }

        function createVelocityChart(results, params) {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            
            if (velocityChart) {
                velocityChart.destroy();
            }

            const depths = Array.from({length: 21}, (_, i) => i * params.avgDepth / 20);
            const velocities = depths.map(depth => {
                const surfaceVel = parseFloat(results.residualFlow);
                const depthFactor = Math.exp(-depth / (params.avgDepth * 0.3));
                return surfaceVel * depthFactor + (Math.random() - 0.5) * 0.02;
            });

            velocityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: depths.map(d => d.toFixed(1)),
                    datasets: [{
                        label: 'Velocity (m/s)',
                        data: velocities,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Depth (m)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Velocity (m/s)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function createSalinityChart(params) {
            const ctx = document.getElementById('salinityChart').getContext('2d');
            
            if (salinityChart) {
                salinityChart.destroy();
            }

            const distances = Array.from({length: 21}, (_, i) => i * 0.5);
            const salinities = distances.map(dist => {
                const riverInfluence = Math.exp(-dist / 3);
                return params.surfaceSalinity + (params.bottomSalinity - params.surfaceSalinity) * (1 - riverInfluence);
            });

            salinityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: distances.map(d => d.toFixed(1)),
                    datasets: [{
                        label: 'Salinity (psu)',
                        data: salinities,
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Distance from River (km)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Salinity (psu)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function generateAnalysis(results, params) {
            const analysisDiv = document.getElementById('analysisText');
            
            let analysis = `<div class="mb-4">
                <h4 class="font-semibold text-lg mb-2">üåä Hydrodynamic Assessment</h4>
                <p>The estuarine system shows a residual flow of ${results.residualFlow} m/s, indicating ${parseFloat(results.residualFlow) > 0.1 ? 'strong' : 'moderate'} net circulation. 
                The river discharge of ${params.riverDischarge} m¬≥/s provides the primary driving force for the gravitational circulation.</p>
            </div>`;

            analysis += `<div class="mb-4">
                <h4 class="font-semibold text-lg mb-2">üåÄ Mixing Dynamics</h4>
                <p>With a mixing rate of ${results.mixingRate}, the system exhibits ${parseFloat(results.mixingRate) > 1.0 ? 'high' : 'moderate'} turbulent mixing. 
                The tidal range of ${params.tidalRange} m and wind speed of ${params.windSpeed} m/s contribute significantly to vertical mixing processes.</p>
            </div>`;

            analysis += `<div class="mb-4">
                <h4 class="font-semibent text-lg mb-2">‚è±Ô∏è Residence Time</h4>
                <p>The calculated flushing time of ${results.flushingTime} days indicates ${parseFloat(results.flushingTime) < 10 ? 'rapid' : 'slow'} water renewal. 
                This affects nutrient cycling, pollutant dispersion, and ecological processes within the estuary.</p>
            </div>`;

            analysis += `<div class="mb-4">
                <h4 class="font-semibold text-lg mb-2">üßÇ Salinity Structure</h4>
                <p>The salinity gradient from ${params.riverSalinity} psu (river) to ${params.bottomSalinity} psu (marine) creates a 
                ${params.stratification > 0.7 ? 'highly stratified' : 'well-mixed'} water column, influencing the estuarine circulation pattern.</p>
            </div>`;

            analysisDiv.innerHTML = analysis;
        }

        // Initialize with default calculation
        window.addEventListener('load', function() {
            setTimeout(calculateCirculation, 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d04b54433fb522',t:'MTc1NDgzNzMwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
